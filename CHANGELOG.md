# 更新日志

## [5.0.1] - 2025-09-01

### 🔧 关键修复
- **修复实体平台设置错误**: 解决"Error setting up entry"导致实体无法创建的问题
- **修复导入错误**: 移除不存在的device_info模块导入
- **修复设备通道设置**: 确保多通道开关正确设置通道数
- **清理文档**: 移除冗余文档，只保留必要文件

### ✨ 设备实体创建优化
- **根据协议正确识别设备**: 支持零火开关(0x01)、人体感应(0x08)、透传模块(0x14)等
- **自动创建对应实体**: 开关设备创建switch实体，传感器创建binary_sensor实体
- **多通道支持**: 根据设备子类型正确创建多个通道实体

### 🐛 修复的问题
- 修复了实体平台初始化失败的问题
- 修复了device_info导入错误
- 修复了设备通道数设置错误
- 修复了设备列表响应后实体不创建的问题

## [4.6.0] - 2024-12-19

### 🎯 核心修复
- **修复集成初始化时实体不创建的问题**: 在协调器初始化时主动读取设备列表
- **修复设备列表响应处理**: 确保设备列表响应被正确路由和处理
- **简化实体创建逻辑**: 移除复杂的动态创建机制，改为在平台初始化时直接创建

### ✨ 功能改进
- **即时实体创建**: 集成添加完成后立即创建所有设备对应的实体
- **自动设备同步**: 协调器初始化时自动读取网关下的所有设备
- **简化架构**: 移除不必要的动态实体创建回调机制

### 🔧 技术优化
- 协调器在初始化时主动调用`async_read_device_list()`
- 等待设备列表响应处理完成后再创建实体
- 实体平台直接从`coordinator.discovered_devices`创建实体
- 修复了设备列表响应的opcode路由问题

### 🐛 修复的问题
- 修复了集成添加完成后需要手动操作才能看到实体的问题
- 修复了设备列表响应处理的路由错误
- 修复了协调器初始化时不读取设备列表的问题

## [4.5.0] - 2024-12-19

### 🎯 重大修复
- **修复设备实体不自动创建的问题**: 彻底解决了设备发现后实体不生成的核心问题
- **修复常量定义错误**: 解决了`OP_RESP_DEVICE_LIST`未定义的错误

### ✨ 新功能
- **动态实体创建**: 设备发现后自动创建对应的Home Assistant实体
- **实时设备同步**: 点击"亖米读取设备列表"后立即生成所有设备实体
- **智能防重复**: 自动防止重复创建相同设备的实体
- **多通道支持**: 自动为多通道设备创建独立的控制实体

### 🔧 技术改进
- 重构了实体平台的设备发现机制
- 优化了协调器的设备状态同步
- 改进了TCP通信协议解析
- 增强了错误处理和日志记录
- 完善了设备管理器的设备跟踪

### 📊 支持的实体类型
- **开关实体**: 单通道和多通道开关设备
- **灯光实体**: 支持调光和色温控制
- **二进制传感器**: 门磁、人体感应等传感器

### 🐛 修复的问题
- 修复了设备列表读取后实体不创建的问题
- 修复了常量导入错误导致的帧处理失败
- 修复了设备发现回调机制的异步处理问题
- 修复了多通道设备实体创建逻辑

## [4.4.0] - 2024-12-19

### 🔧 技术改进
- 初步实现动态实体创建机制
- 改进设备发现回调处理

## [4.3.2] - 2024-12-19

### 🐛 修复
- 修复TCP通信稳定性问题
- 优化设备状态同步机制

## [4.3.1] - 2024-12-19

### 🔧 改进
- 优化设备发现流程
- 改进错误处理机制

## [4.3.0] - 2024-12-19

### ✨ 新功能
- 添加设备自动发现功能
- 支持TCP和串口双模式连接
- 实现设备状态实时同步

### 🎯 支持的设备
- 零火开关 (1-6路)
- 单火开关 (1-4路)
- 智能灯具
- 门磁传感器
- 人体感应传感器
- 智能插座

### 🔧 技术特性
- 完整的协议栈实现
- 设备持久化存储
- 异步通信处理
- 错误恢复机制

# 更新日志

## [4.7.0] - 2024-12-19

### 🎯 重新配置功能
- **添加重新配置选项**: 集成设置中新增"重新配置"选项，无需删除重新添加
- **智能设备同步**: 每次重新配置时自动检查并添加新设备
- **防重复创建**: 只新增不同ID的设备，不重复生成相同实体
- **保护已有实体**: 不删除已配置的实体，只允许从HA中手动删除

### ✨ 动态实体管理
- **增量实体创建**: 支持运行时动态添加新发现的设备实体
- **实体ID追踪**: 维护已创建实体的ID集合，避免重复创建
- **平台回调机制**: 各实体平台支持动态添加新实体

### 🔧 协议修复
- **修复设备状态响应**: 正确处理opcode=0xB2的设备状态查询响应
- **完善帧路由**: 添加设备状态响应处理器，避免"Unhandled frame"错误
- **响应日志优化**: 改进设备状态响应的日志记录

### 🏗️ 架构优化
- **简化设备发现**: 移除复杂的动态检测，改为配置时主动同步
- **状态持久化**: 实体创建状态在协调器中持久化
- **回调优化**: 优化设备发现回调机制，提高响应效率

### 🐛 修复的问题
- 修复了重新配置时需要删除集成的问题
- 修复了设备状态响应未处理的错误
- 修复了实体重复创建的问题
- 修复了新设备无法自动添加的问题

## [4.6.0] - 2024-12-19

### 🎯 核心修复
- **修复集成初始化时实体不创建的问题**: 在协调器初始化时主动读取设备列表
- **修复设备列表响应处理**: 确保设备列表响应被正确路由和处理
- **简化实体创建逻辑**: 移除复杂的动态创建机制，改为在平台初始化时直接创建

### ✨ 功能改进
- **即时实体创建**: 集成添加完成后立即创建所有设备对应的实体
- **自动设备同步**: 协调器初始化时自动读取网关下的所有设备
- **简化架构**: 移除不必要的动态实体创建回调机制

### 🔧 技术优化
- 协调器在初始化时主动调用`async_read_device_list()`
- 等待设备列表响应处理完成后再创建实体
- 实体平台直接从`coordinator.discovered_devices`创建实体
- 修复了设备列表响应的opcode路由问题

### 🐛 修复的问题
- 修复了集成添加完成后需要手动操作才能看到实体的问题
- 修复了设备列表响应处理的路由错误
- 修复了协调器初始化时不读取设备列表的问题

## [4.5.0] - 2024-12-19

### 🎯 重大修复
- **修复设备实体不自动创建的问题**: 彻底解决了设备发现后实体不生成的核心问题
- **修复常量定义错误**: 解决了`OP_RESP_DEVICE_LIST`未定义的错误

### ✨ 新功能
- **动态实体创建**: 设备发现后自动创建对应的Home Assistant实体
- **实时设备同步**: 点击"亖米读取设备列表"后立即生成所有设备实体
- **智能防重复**: 自动防止重复创建相同设备的实体
- **多通道支持**: 自动为多通道设备创建独立的控制实体

### 🔧 技术改进
- 重构了实体平台的设备发现机制
- 优化了协调器的设备状态同步
- 改进了TCP通信协议解析
- 增强了错误处理和日志记录
- 完善了设备管理器的设备跟踪

### 📊 支持的实体类型
- **开关实体**: 单通道和多通道开关设备
- **灯光实体**: 支持调光和色温控制
- **二进制传感器**: 门磁、人体感应等传感器

### 🐛 修复的问题
- 修复了设备列表读取后实体不创建的问题
- 修复了常量导入错误导致的帧处理失败
- 修复了设备发现回调机制的异步处理问题
- 修复了多通道设备实体创建逻辑

## [4.4.0] - 2024-12-19

### 🔧 技术改进
- 初步实现动态实体创建机制
- 改进设备发现回调处理

## [4.3.2] - 2024-12-19

### 🐛 修复
- 修复TCP通信稳定性问题
- 优化设备状态同步机制

## [4.3.1] - 2024-12-19

### 🔧 改进
- 优化设备发现流程
- 改进错误处理机制

## [4.3.0] - 2024-12-19

### ✨ 新功能
- 添加设备自动发现功能
- 支持TCP和串口双模式连接
- 实现设备状态实时同步

### 🎯 支持的设备
- 零火开关 (1-6路)
- 单火开关 (1-4路)
- 智能灯具
- 门磁传感器
- 人体感应传感器
- 智能插座

### 🔧 技术特性
- 完整的协议栈实现
- 设备持久化存储
- 异步通信处理
- 错误恢复机制

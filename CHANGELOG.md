# 更新日志

## [5.0.0] - 2025-09-01

### 🎯 重大重构 - 使用2025年HA最新技术栈
- **彻底重构集成架构**: 使用HA 2025.1.0最新API和最佳实践
- **简化设备发现**: 移除不必要的手动按钮，确保自动发现后立即创建所有实体
- **修复所有日志错误**: 解决ATTR_COLOR_TEMP弃用和OP_RESP_DEVICE_STATUS_QUERY未定义问题

### ✨ 核心功能优化
- **自动设备同步**: 集成添加完成后立即获取并创建所有设备实体
- **智能实体管理**: 防重复创建，只新增不同ID的设备
- **简化用户体验**: 移除"亖米读取设备列表"和"亖米网关调试日志"按钮

### 🔧 技术改进
- **更新到HA 2025.1.0**: 使用最新的Home Assistant API
- **修复颜色温度**: 使用ATTR_COLOR_TEMP_KELVIN替代已弃用的ATTR_COLOR_TEMP
- **完善协议处理**: 修复设备状态响应处理，避免"Unhandled frame"错误
- **优化设备加载**: 增加等待时间确保设备列表完全加载

### 🏗️ 架构简化
- **精简平台**: 只保留switch、light、binary_sensor三个核心平台
- **移除冗余功能**: 删除不必要的管理开关和调试功能
- **优化初始化**: 确保协调器初始化时完整读取设备列表

### 🐛 修复的问题
- 修复了ATTR_COLOR_TEMP弃用警告
- 修复了OP_RESP_DEVICE_STATUS_QUERY未定义错误
- 修复了设备列表响应处理问题
- 修复了自动发现后实体不创建的问题

## [4.6.0] - 2024-12-19

### 🎯 核心修复
- **修复集成初始化时实体不创建的问题**: 在协调器初始化时主动读取设备列表
- **修复设备列表响应处理**: 确保设备列表响应被正确路由和处理
- **简化实体创建逻辑**: 移除复杂的动态创建机制，改为在平台初始化时直接创建

### ✨ 功能改进
- **即时实体创建**: 集成添加完成后立即创建所有设备对应的实体
- **自动设备同步**: 协调器初始化时自动读取网关下的所有设备
- **简化架构**: 移除不必要的动态实体创建回调机制

### 🔧 技术优化
- 协调器在初始化时主动调用`async_read_device_list()`
- 等待设备列表响应处理完成后再创建实体
- 实体平台直接从`coordinator.discovered_devices`创建实体
- 修复了设备列表响应的opcode路由问题

### 🐛 修复的问题
- 修复了集成添加完成后需要手动操作才能看到实体的问题
- 修复了设备列表响应处理的路由错误
- 修复了协调器初始化时不读取设备列表的问题

## [4.5.0] - 2024-12-19

### 🎯 重大修复
- **修复设备实体不自动创建的问题**: 彻底解决了设备发现后实体不生成的核心问题
- **修复常量定义错误**: 解决了`OP_RESP_DEVICE_LIST`未定义的错误

### ✨ 新功能
- **动态实体创建**: 设备发现后自动创建对应的Home Assistant实体
- **实时设备同步**: 点击"亖米读取设备列表"后立即生成所有设备实体
- **智能防重复**: 自动防止重复创建相同设备的实体
- **多通道支持**: 自动为多通道设备创建独立的控制实体

### 🔧 技术改进
- 重构了实体平台的设备发现机制
- 优化了协调器的设备状态同步
- 改进了TCP通信协议解析
- 增强了错误处理和日志记录
- 完善了设备管理器的设备跟踪

### 📊 支持的实体类型
- **开关实体**: 单通道和多通道开关设备
- **灯光实体**: 支持调光和色温控制
- **二进制传感器**: 门磁、人体感应等传感器

### 🐛 修复的问题
- 修复了设备列表读取后实体不创建的问题
- 修复了常量导入错误导致的帧处理失败
- 修复了设备发现回调机制的异步处理问题
- 修复了多通道设备实体创建逻辑

## [4.4.0] - 2024-12-19

### 🔧 技术改进
- 初步实现动态实体创建机制
- 改进设备发现回调处理

## [4.3.2] - 2024-12-19

### 🐛 修复
- 修复TCP通信稳定性问题
- 优化设备状态同步机制

## [4.3.1] - 2024-12-19

### 🔧 改进
- 优化设备发现流程
- 改进错误处理机制

## [4.3.0] - 2024-12-19

### ✨ 新功能
- 添加设备自动发现功能
- 支持TCP和串口双模式连接
- 实现设备状态实时同步

### 🎯 支持的设备
- 零火开关 (1-6路)
- 单火开关 (1-4路)
- 智能灯具
- 门磁传感器
- 人体感应传感器
- 智能插座

### 🔧 技术特性
- 完整的协议栈实现
- 设备持久化存储
- 异步通信处理
- 错误恢复机制

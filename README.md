# 亖米Mesh网关 Home Assistant集成

[![hacs_badge](https://img.shields.io/badge/HACS-Custom-orange.svg)](https://github.com/custom-components/hacs)
[![GitHub release](https://img.shields.io/github/release/symi-daguo/symi_gateway.svg)](https://github.com/symi-daguo/symi_gateway/releases)
[![License](https://img.shields.io/github/license/symi-daguo/symi_gateway.svg)](LICENSE)

这是一个用于Home Assistant的亖米Mesh网关集成，支持通过串口和TCP连接网关，自动发现和控制亖米Mesh网络中的智能设备。

## 🎯 最新更新 v5.0.0 - 重大架构升级

### 🚀 架构重构
- **TCP直连架构**: 参考易来（Yeelight Pro）成功模式，采用TCP直连网关
- **简化通信协议**: 使用JSON消息格式，告别复杂的字节协议
- **自动设备发现**: 通过`gateway_get.topology`命令自动获取所有设备
- **实时状态同步**: 通过`gateway_post.prop`和`gateway_post.event`实时更新

### 🐛 问题修复
- **彻底解决字节类型错误**: `'bytes' object cannot be interpreted as an integer`
- **修复设备控制失败**: 设备现在可以正常开关控制
- **优化连接稳定性**: TCP连接更加稳定可靠
- **简化代码架构**: 去除冗余代码，专注核心功能

## 🌟 功能特性

### 核心功能
- **TCP直连网关**: 稳定的TCP连接，端口4196
- **自动设备发现**: 连接后自动发现所有已配对设备
- **即插即用**: 搜索网关后点击添加就完成所有实体创建
- **实时状态同步**: 设备状态实时更新到Home Assistant
- **简洁高效**: 参考易来架构，代码简洁可靠

### 支持的设备类型
- **开关类**: 单路/双路/三路开关
- **灯光类**: 调光灯、双色温调光灯
- **传感器类**: 人体感应传感器
- **其他**: 更多设备类型持续添加中

## 📋 系统要求

- Home Assistant 2023.1.0 或更高版本
- Python 3.11 或更高版本
- TCP网络连接到亖米网关设备

## 🚀 安装方法

### 方法1: HACS安装 (推荐)
1. 确保已安装HACS
2. 在HACS中添加自定义存储库: `https://github.com/yourusername/symi-mqtt`
3. 搜索并安装"Symi Gateway"
4. 重启Home Assistant
5. 在集成页面添加集成

### 方法2: 手动安装
1. 下载此集成的所有文件
2. 将 `custom_components/symi_gateway` 文件夹复制到你的Home Assistant配置目录下的 `custom_components` 文件夹中
3. 重启Home Assistant
4. 在集成页面搜索"Symi Gateway"并添加

## ⚙️ 配置步骤

### 1. 网络连接
- 确保亖米网关已连接到网络
- 确保Home Assistant设备与网关在同一网络
- 记录网关的IP地址（端口默认为4196）

### 2. 添加集成
1. 进入Home Assistant的"配置" → "设备与服务"
2. 点击"添加集成"
3. 搜索"Symi Gateway"
4. 输入网关IP地址
5. 点击"提交"

### 3. 自动设备发现
1. 集成添加成功后，会自动连接到网关
2. 系统会自动发现并创建所有已配对的设备实体
3. 就像易来一样，搜索网关后点击添加就完成了所有实体的创建

## 🎮 使用说明

### 设备发现
- **开启发现模式**: 打开"设备发现模式"开关
- **配网设备**: 长按设备配网键直到指示灯快速闪烁
- **自动添加**: 设备会自动被发现并添加到HA
- **发现超时**: 发现模式会在120秒后自动关闭

### 设备控制
- **开关设备**: 直接在HA界面中控制开关状态
- **调光设备**: 支持亮度和色温调节
- **窗帘设备**: 支持开启、关闭、停止和位置控制
- **传感器**: 自动读取温度、湿度、照度等数据

### 服务调用
```yaml
# 开始设备扫描
service: symi_gateway.start_scan

# 停止设备扫描  
service: symi_gateway.stop_scan

# 网关恢复出厂设置
service: symi_gateway.factory_reset

# 重启网关
service: symi_gateway.reboot_gateway
```

## 🔧 故障排除

### 常见问题

#### 1. 配置界面问题
**症状**: 配置界面没有显示连接方式选择，或显示旧的字段
**解决方案**:
- 删除现有的集成配置
- 重启Home Assistant
- 清除浏览器缓存 (Ctrl+F5)
- 重新添加集成

#### 2. 没有显示设备发现开关
**症状**: 集成添加成功但没有"亖米设备发现模式"开关
**解决方案**:
- 检查日志中是否有错误信息
- 确认集成正确加载：`日志` → 搜索 "symi_gateway"`
- 重启Home Assistant
- 重新添加集成

#### 3. 串口连接失败
**症状**: 集成添加失败，提示"无法连接到串口"
**解决方案**:
- 检查串口路径是否正确
- 确认设备已连接并上电
- 检查串口权限 (Linux: `sudo usermod -a -G dialout homeassistant`)
- 确认没有其他程序占用串口

#### 4. TCP连接失败
**症状**: TCP连接配置失败
**解决方案**:
- 确认网关IP地址正确
- 检查网络连通性 (`ping 网关IP`)
- 确认端口号正确 (默认为4196)
- 检查防火墙设置

#### 5. 设备发现失败
**症状**: 开启发现模式后无法发现设备
**解决方案**:
- 确认网关已正常连接
- 检查设备是否正确进入配网模式
- 确认设备与网关距离不要太远
- 重启网关后重试

#### 6. 设备控制无响应
**症状**: 在HA中控制设备无反应
**解决方案**:
- 检查设备是否在线
- 确认网关与设备通信正常
- 重启集成或重新配网设备

#### 7. 实体ID冲突错误
**症状**: 日志显示"Platform symi_gateway does not generate unique IDs"
**解决方案**:
- 删除现有集成配置
- 重启Home Assistant
- 重新添加集成
- 如果问题持续，检查是否有重复的MAC地址

#### 8. 只发现部分设备
**症状**: 只发现了一个设备，但实际有多个设备
**解决方案**:
- 检查其他设备是否正常上电
- 确认设备已正确配网到网关
- 重启网关后重新发现设备
- 检查设备是否在网关的通信范围内

### 日志调试
在 `configuration.yaml` 中添加以下配置启用详细日志:
```yaml
logger:
  default: info
  logs:
    custom_components.symi_gateway: debug
```

### 查看串口通信数据
启用调试日志后，可以在Home Assistant日志中查看详细的串口通信数据：
1. 进入 `设置` → `系统` → `日志`
2. 搜索 "symi_gateway"
3. 查看发送和接收的数据帧

### 重置集成
如果遇到问题，可以完全重置集成：
1. 删除现有集成：`设置` → `设备与服务` → 找到"亖米Mesh网关" → `删除`
2. 重启Home Assistant
3. 重新添加集成

## 📚 技术规格

### 协议规范
- **协议版本**: 亖米Gateway Protocol V1.0 (BCM/QM10-202112)
- **通信方式**: TCP网络连接 (端口4196)
- **协议格式**: 头码(0x53) + 操作码 + 状态/长度 + 数据 + 校验码
- **设备数据**: 16字节格式 (MAC+地址+类型+RSSI等)

### 支持的设备类型
| 类型码 | 设备名称 | 子类型含义 | Home Assistant平台 |
|--------|----------|------------|-------------------|
| 1 | 零火开关 | 1-6路 | switch |
| 2 | 单火开关 | 1-6路 | switch |
| 3 | 智能插座 | - | switch |
| 4 | 智能灯 | - | light |
| 5 | 智能窗帘 | - | cover |
| 7 | 门磁传感器 | - | binary_sensor |
| 8 | 人体感应 | - | binary_sensor |
| 9 | 插卡取电 | - | switch |
| 10 | 温控器 | - | climate |
| 11 | 温湿度传感器 | - | sensor |
| 24 | 五色调光灯 | - | light |
| 74 | 透传模块 | - | switch |

### 系统规格
- **网络拓扑**: Mesh网络，最大支持105个设备
- **响应时间**: < 200ms
- **数据持久化**: 自动保存设备配置
- **Python版本**: 3.11+
- **Home Assistant**: 2025.1.0+

## 🤝 贡献

欢迎提交Issue和Pull Request来改进这个集成。

## 📄 许可证

本项目采用MIT许可证。

## 🔗 相关链接

- [Home Assistant官网](https://www.home-assistant.io/)
- [Symi官网](https://www.beancomm.com/)
- [问题反馈](https://github.com/symi/symi-gateway-ha/issues)

## 📋 更新日志

### v5.2.0 (2025-01-02) - 🔧 协议解析重大修复
**✅ 重大问题修复**
- **协议解析完全重写**: 根据网关串口协议文档重新实现设备列表解析
- **设备类型映射完善**: 添加所有协议支持的设备类型(1-74)
- **数据结构修正**: 按照 `dev_list_node_rsp_t` 结构正确解析16字节设备数据
- **字节序修复**: 修正网络地址和厂商ID的小端序解析问题
- **设备发现优化**: 修复只能发现1个设备的问题，现在能正确识别所有11个设备
- **实体创建改进**: 完善各种设备类型的Home Assistant实体创建逻辑

**🆕 新增功能**
- 设备信息持久化存储
- 智能实体去重机制
- 增强的错误处理机制
- 改进的调试日志输出

**📋 支持的设备类型**
- 零火开关、单火开关 (1-6路)
- 智能插座、智能灯、智能窗帘
- 情景面板、门磁传感器、人体感应
- 插卡取电、温控器、温湿度传感器
- 情景开关、门锁、水浸/烟感报警器
- 透传模块、五色调光灯等

### v5.1.3 (2025-01-15) - 实体创建修复版本 ✅
- **🔧 修复unique_id冲突**：解决"Platform symi_gateway does not generate unique IDs"错误
- **📱 优化实体创建逻辑**：避免重复创建实体，只为新发现的设备创建实体
- **🔍 改进设备发现**：支持多次查询以发现所有设备
- **🎮 修复透传模块支持**：正确处理类型74透传模块的capabilities
- **⚙️ 完善错误处理**：更好的错误日志和异常处理
- **📊 优化代码结构**：清理冗余代码，提高代码质量

### v5.1.2 (2025-01-15) - 完全修复版本 ✅
- **🔧 修复所有导入错误**：解决平台文件导入问题
- **📱 恢复原始协议**：使用正确的字节级通信协议
- **🔍 修复设备发现**：局域网自动搜索和手动配置都正常工作
- **🎮 修复设备控制**：开关、调光等功能完全正常
- **⚙️ 添加重新配置**：支持重新配置网关连接参数
- **📊 完善实体创建**：基于真实设备数据创建正确的实体
- **🐛 解决所有报错**：修复字节类型错误和导入错误

### v5.1.1 (2025-01-15) - 恢复原始架构
- 恢复protocol.py：使用原始字节协议而非JSON
- 恢复tcp_comm.py：正确的TCP通信实现
- 恢复device_manager.py：完整的设备管理功能
- 恢复coordinator.py：事件驱动的协调器

### v5.1.0 (2025-01-15) - 紧急修复
- 恢复局域网自动搜索功能
- 修复设备实体创建问题
- 修复已弃用常量警告
- 修复设备控制问题

### v5.0.0 (2025-01-15) - 重大架构升级
- 架构重构：采用TCP直连模式
- 简化通信：使用JSON消息格式
- 问题修复：解决字节类型错误
- 提升性能：设备控制响应更快

---

**注意**: 本集成需要Symi网关硬件支持，请确保您有相应的硬件设备。

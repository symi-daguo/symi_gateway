# 亖米Mesh网关设置指南

## 🚨 重要提示

如果您看到的配置界面仍然只显示串口配置（port和baudrate），这是因为Home Assistant缓存了旧的配置流程。请按以下步骤操作：

## 🔄 清除缓存步骤

### 1. 删除现有集成
1. 进入 `设置` → `设备与服务`
2. 找到"亖米Mesh网关"或"SYMI亖米Mesh网关"
3. 点击集成，然后点击右上角的三个点
4. 选择`删除`

### 2. 重启Home Assistant
1. 进入 `设置` → `系统` → `重启`
2. 点击`重启Home Assistant`
3. 等待重启完成

### 3. 清除浏览器缓存
1. 按 `Ctrl + F5` (Windows) 或 `Cmd + Shift + R` (Mac)
2. 或者在浏览器中按 `F12` → `Network` → 勾选 `Disable cache`

### 4. 重新添加集成
1. 进入 `设置` → `设备与服务`
2. 点击右下角的 `+ 添加集成`
3. 搜索 `亖米` 或 `symi`
4. 选择 `亖米Mesh网关`

## ✅ 正确的配置流程

### 第一步：连接方式选择
您应该看到：
```
标题：亖米Mesh网关
描述：选择连接网关的方式

连接方式：[下拉菜单]
- 串口连接
- TCP网络连接
```

### 第二步A：串口配置（如果选择串口连接）
```
标题：串口连接配置
串口路径：[输入框] 如 COM3 或 /dev/ttyUSB0
波特率：[下拉菜单] 115200
```

### 第二步B：TCP配置（如果选择TCP连接）
```
标题：TCP网络连接配置
IP地址：[输入框] 如 192.168.1.100
端口号：[输入框] 如 8899
```

## 🎛️ 配置完成后的功能

### 开关实体
配置成功后，您应该看到以下开关：
- **亖米设备发现模式** - 开启/关闭设备扫描
- **亖米网关恢复出厂设置** - 重置网关（⚠️ 会清除所有设备）
- **亖米网关调试日志** - 开启/关闭详细日志

### 传感器实体
- **亖米网关状态** - 显示连接状态和详细信息

### 查看通信日志
1. 开启"亖米网关调试日志"开关
2. 进入 `设置` → `系统` → `日志`
3. 搜索 "symi_gateway"
4. 可以看到详细的TCP/串口通信数据

## 🔍 故障排除

### 如果仍然只显示串口配置
1. 确认已完全删除旧的集成配置
2. 确认已重启Home Assistant
3. 确认已清除浏览器缓存
4. 检查集成版本是否为 2.2.0

### "already_configured" 错误
**症状**: 添加集成时提示"already_configured"
**解决方案**:
1. 删除所有现有的亖米相关集成和设备
2. 重启Home Assistant
3. 清除浏览器缓存
4. 重新添加集成
5. 详细步骤请参考 `CLEAR_CONFIG.md`

### 查看集成版本
1. 进入 `设置` → `设备与服务`
2. 找到已安装的集成
3. 查看版本号应该是 2.5.0

### 启用调试日志
在 `configuration.yaml` 中添加：
```yaml
logger:
  default: info
  logs:
    custom_components.symi_gateway: debug
```

然后重启HA，在日志中搜索 "Config flow" 查看配置流程的详细信息。

## 🔧 常见错误修复

### ImportError: cannot import name 'UnitOfIlluminance'
这个错误已经修复，集成现在兼容不同版本的Home Assistant。

### Failed to load services.yaml
这个错误已经修复，现在包含了完整的services.yaml文件。

### Error setting up entry
如果仍然遇到设置错误：
1. 确认使用最新版本 (2.3.0)
2. 删除集成并重新添加
3. 检查Home Assistant版本是否支持 (2023.1.0+)

## 📞 获取帮助

如果按照以上步骤操作后仍然有问题，请提供：
1. Home Assistant版本
2. 浏览器类型和版本
3. 集成版本号
4. 日志中的相关错误信息

## 🎯 预期结果

正确配置后，您应该看到：
- ✅ 连接方式选择界面
- ✅ 根据选择显示对应的配置选项
- ✅ 配置完成后显示"亖米Mesh网关"设备
- ✅ 显示"亖米设备发现模式"开关
